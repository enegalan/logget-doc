name: Algolia Sync

on:
  workflow_dispatch:
  schedule:
    # Ejecuta diariamente a las 2 AM UTC
    - cron: '0 2 * * *'
  workflow_run:
    workflows: ["Deploy to GitHub Pages"]
    types:
      - completed

jobs:
  algolia:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Algolia CLI
        run: npm install -g @algolia/cli
      
      - name: Sync Algolia
        env:
          ALGOLIA_APP_ID: ${{ secrets.ALGOLIA_APP_ID }}
          ALGOLIA_API_KEY: ${{ secrets.ALGOLIA_API_KEY }}
          ALGOLIA_SEARCH_API_KEY: ${{ secrets.ALGOLIA_SEARCH_API_KEY }}
        run: |
          # Use ALGOLIA_API_KEY or ALGOLIA_SEARCH_API_KEY (both are supported)
          API_KEY="${ALGOLIA_API_KEY:-$ALGOLIA_SEARCH_API_KEY}"
          
          if [ -z "$API_KEY" ] || [ -z "$ALGOLIA_APP_ID" ]; then
            echo "‚ö†Ô∏è  Algolia credentials not set. Skipping Algolia sync."
            echo "To enable automatic sync, add ALGOLIA_APP_ID and ALGOLIA_API_KEY to GitHub Secrets"
            exit 0
          fi
          echo "üîÑ Syncing Algolia indices..."
          algolia login --application-id $ALGOLIA_APP_ID --api-key $API_KEY --yes
          algolia crawler start .algolia/algolia-config.json || echo "‚ö†Ô∏è  Crawler failed. Make sure the crawler is configured in Algolia dashboard."
          echo "‚úÖ Algolia sync completed"

