name: Algolia Sync

on:
  workflow_dispatch:
  schedule:
    # Ejecuta diariamente a las 2 AM UTC
    - cron: '0 2 * * *'
  workflow_run:
    workflows: ["Deploy to GitHub Pages"]
    types:
      - completed

jobs:
  algolia:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Algolia CLI
        run: npm install -g @algolia/cli
      
      - name: Sync Algolia
        env:
          # Use Crawler-specific credentials (RECOMMENDED)
          CRAWLER_USER_ID: ${{ secrets.CRAWLER_USER_ID }}
          CRAWLER_API_KEY: ${{ secrets.CRAWLER_API_KEY }}
          # Fallback to standard Algolia credentials (optional)
          ALGOLIA_APP_ID: ${{ secrets.ALGOLIA_APP_ID }}
          ALGOLIA_API_KEY: ${{ secrets.ALGOLIA_API_KEY }}
        run: |
          # Check if Crawler credentials are set (preferred method)
          if [ -n "$CRAWLER_USER_ID" ] && [ -n "$CRAWLER_API_KEY" ]; then
            echo "‚úÖ Using Crawler-specific credentials"
          # Fallback to standard Algolia credentials
          elif [ -n "$ALGOLIA_API_KEY" ] && [ -n "$ALGOLIA_APP_ID" ]; then
            echo "‚úÖ Using standard Algolia credentials"
          else
            echo "‚ö†Ô∏è  Algolia credentials not set. Skipping Algolia sync."
            echo ""
            echo "To enable automatic sync, add one of the following to GitHub Secrets:"
            echo ""
            echo "Option 1 (RECOMMENDED): Crawler-specific credentials"
            echo "  - CRAWLER_USER_ID: Get from https://crawler.algolia.com/admin/user/settings/"
            echo "  - CRAWLER_API_KEY: Get from https://crawler.algolia.com/admin/user/settings/"
            echo ""
            echo "Option 2: Standard Algolia credentials"
            echo "  - ALGOLIA_APP_ID: Your Application ID"
            echo "  - ALGOLIA_API_KEY: Your Admin API Key (must have crawler permissions)"
            exit 0
          fi
          echo "üîÑ Syncing Algolia indices..."
          # Use the Node.js script which uses the Algolia API directly
          node scripts/sync-algolia.js || echo "‚ö†Ô∏è  Crawler failed. Make sure the crawler is configured in Algolia dashboard."
          echo "‚úÖ Algolia sync completed"

